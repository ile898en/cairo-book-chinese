# EC OP 内置函数

_EC OP_（椭圆曲线操作）内置函数在 STARK 曲线上执行椭圆曲线操作。具体来说，它计算 R = P + mQ，其中 P 和 Q 是曲线上的点，m 是标量乘数。每个点（P、Q 和 R）由一对表示其 x 和 y 坐标的 field 元素表示。

该内置函数能够高效地实现需要椭圆曲线算术的加密算法，与直接在 Cairo 代码中实现这些操作相比，具有显着的性能优势。

## 单元格组织

EC OP 内置函数在 Cairo VM 运行期间拥有自己专用的段。每个操作由一个 7 个单元格的块表示：

| 偏移量 | 描述       | 角色   |
| ------ | ---------- | ------ |
| 0      | P.x 坐标   | 输入   |
| 1      | P.y 坐标   | 输入   |
| 2      | Q.x 坐标   | 输入   |
| 3      | Q.y 坐标   | 输入   |
| 4      | m 标量值   | 输入   |
| 5      | R.x 坐标   | 输出   |
| 6      | R.y 坐标   | 输出   |

前五个单元格是必须由程序写入的输入，而后两个单元格是在读取时将由 VM 计算的输出。

### 有效操作示例

在此示例中，我们可以看到正确配置的 EC OP 内置函数操作：

<div align="center">
  <img src="ecop-segment.png" alt="EC OP builtin segment" width="450px"/>
</div>
<div align="center">
  <span class="caption">快照 1 - 具有完整输入值的有效 EC OP 段</span>
</div>

程序已正确设置：

- 点 P 坐标
- 点 Q 坐标
- 标量 m 值

当程序读取偏移量 5 和 6 处的单元格时，VM 计算 R = P + mQ 并返回结果坐标。

### 错误条件示例

在此示例中，我们看到尝试使用不完整的输入读取结果时的错误条件：

<div align="center">
  <img src="ecop-invalid-inputs.png" alt="Incomplete input values in EC OP builtin segment" width="450px"/>
</div>
<div align="center">
  <span class="caption">快照 2 - 由于输入值不完整导致的错误</span>
</div>

程序尝试读取偏移量 5 和 6 处的输出单元格，但 VM 无法计算 R = P + mQ，因为：

- 点 P 坐标已正确设置
- 点 Q 坐标缺失（两个单元格都为空）
- 标量 m 值已设置

由于点 Q 的坐标缺失，VM 无法执行计算，并且在尝试读取输出单元格时将抛出错误。

如果任何输入值无效（不是 field 元素）或缺失，EC OP 内置函数在访问其输出时将失败。在读取输出之前，所有五个输入单元格必须包含有效的 field 元素。

## 实现参考

这些 EC OP 内置函数的实现参考可能不详尽：

- [TypeScript EC OP Builtin](https://github.com/kkrt-labs/cairo-vm-ts/blob/main/src/builtins/ecop.ts)
- [Python EC OP Builtin](https://github.com/starkware-libs/cairo-lang/blob/0e4dab8a6065d80d1c726394f5d9d23cb451706a/src/starkware/cairo/lang/builtins/ec/ec_op_builtin_runner.py)
- [Rust EC OP Builtin](https://github.com/lambdaclass/cairo-vm/blob/41476335884bf600b62995f0c005be7d384eaec5/vm/src/vm/runners/builtin_runner/ec_op.rs)
- [Zig EC OP Builtin](https://github.com/keep-starknet-strange/ziggy-starkdust/blob/55d83e61968336f6be93486d7acf8530ba868d7e/src/vm/builtins/builtin_runner/ec_op.zig)

## 关于椭圆曲线操作的资源

如果你对椭圆曲线操作及其加密应感兴趣：

- StarkNet,
  [STARK Curve](https://docs.starknet.io/architecture-and-concepts/cryptography/stark-curve/)
- Andrea Corbellini,
  [Elliptic Curve Cryptography: a gentle introduction](https://andrea.corbellini.name/2015/05/17/elliptic-curve-cryptography-a-gentle-introduction/)
