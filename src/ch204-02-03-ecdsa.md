# ECDSA 内置函数

_ECDSA_（椭圆曲线数字签名算法）内置函数验证 STARK 曲线上的加密签名。此内置函数主要用于验证消息哈希是否由特定私钥的持有者签名。

## 内存组织

ECDSA 内置函数具有独特的内存结构，包含两个相互连接的组件：

1. **内存段**：一个专用段，将公钥和消息哈希存储为 field 元素
2. **签名字典**：一个映射，将公钥偏移量与其对应的签名相关联

### 内存段中的单元格布局

ECDSA 段成对排列单元格：

- **偶数偏移量** (0, 2, 4, ...) 存储公钥
- **奇数偏移量** (1, 3, 5, ...) 存储消息哈希

偏移量 `2n` 处的每个公钥都与偏移量 `2n+1` 处的消息哈希相关联。例如，偏移量 0 处的公钥与偏移量 1 处的哈希配对。

### 签名验证过程

在使用 ECDSA 内置函数之前，必须在该名字典中显式注册签名。当程序将值写入 ECDSA 段时，VM 执行签名验证：

1. 当公钥写入偏移量 `2n` 时，VM 检查它是否与用于创建在该偏移量注册的签名的密钥匹配
2. 当消息哈希写入偏移量 `2n+1` 时，VM 验证它是否与被签名的哈希匹配

如果任何一个检查失败，VM 会立即抛出错误 - 这与其一些他将验证推迟到输出访问的内置函数不同。

### 有效用法示例

<div align="center">
  <img src="ecdsa-full.png" alt="Valid ECDSA builtin segment with signatures"/>
</div>
<div align="center">
  <span class="caption">有效 ECDSA 段使用示例</span>
</div>

在此示例中：

- 偏移量 0 处的公钥_0 和偏移量 1 处的哈希_0 根据存储在字典键 0 处的签名进行验证
- 偏移量 2 处的公钥_1 和偏移量 3 处的哈希_1 根据存储在字典键 2 处的签名进行验证
- 所有验证都通过，因为公钥和哈希与最初签名的内容匹配

### 错误条件

#### 无效哈希错误

<div align="center">
  <img src="ecdsa-invalid-hash.png" alt="ECDSA error due to invalid hash"/>
</div>
<div align="center">
  <span class="caption">错误：哈希与签名消息不匹配</span>
</div>

当程序在偏移量 5 处写入哈希“1324”，但字典键 4 处的签名是为哈希“2025”创建的时，VM 会抛出错误，因为哈希与最初使用该公钥签名的内容不匹配。

#### 无效公钥错误

<div align="center">
  <img src="ecdsa-invalid-key.png" alt="ECDSA error due to invalid public key"/>
</div>
<div align="center">
  <span class="caption">错误：公钥与签名密钥不匹配</span>
</div>

当程序在偏移量 4 处写入公钥“0000”，但字典键 4 处的签名是使用公钥“1515”创建的时，VM 会抛出错误，因为公钥与用于创建签名的公钥不匹配。

## 实现参考

这些 ecdsa 内置函数的实现参考可能并不详尽。

- [TypeScript Signature Builtin](https://github.com/kkrt-labs/cairo-vm-ts/blob/main/src/builtins/ecdsa.ts)
- [Python Signature Builtin](https://github.com/starkware-libs/cairo-lang/blob/0e4dab8a6065d80d1c726394f5d9d23cb451706a/src/starkware/cairo/lang/builtins/signature/signature_builtin_runner.py)
- [Rust Signature Builtin](https://github.com/lambdaclass/cairo-vm/blob/41476335884bf600b62995f0c005be7d384eaec5/vm/src/vm/runners/builtin_runner/signature.rs)
- [Zig Signature Builtin](https://github.com/keep-starknet-strange/ziggy-starkdust/blob/55d83e61968336f6be93486d7acf8530ba868d7e/src/vm/builtins/builtin_runner/signature.zig)

## 关于 ECDSA 签名的资源

如果你对 ecdsa 签名及其使用感兴趣，请查看这些参考资料：

- StarkNet,
  [STARK curve](https://docs.starknet.io/architecture-and-concepts/cryptography/stark-curve/)
- Svetlin Nakov,
  [ECDSA: Elliptic Curve Signatures](https://cryptobook.nakov.com/digital-signatures/ecdsa-sign-verify-messages),
  2020
