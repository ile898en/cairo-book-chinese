# 架构

Cairo 是一种对 STARK 友好的冯·诺依曼架构，能够为任意计算生成有效性证明。对 STARK 友好意味着 Cairo 的设计针对 STARK 证明系统进行了优化，同时保持与其他证明系统后端的兼容性。它实现了一个图灵完备的进程虚拟机。

Cairo 由三个主要组件组成：

1. Cairo 编译器
2. Cairo 虚拟机 (CairoVM)
3. Cairo 证明者和验证者

Cairo 编译器将 Cairo 源代码转换为 Cairo 字节码（编码指令和元数据）。编译器的输出通常被称为 _编译工件_。

CairoVM 实现理论上的 _Cairo 机器_，处理编译工件并执行指令以产生证明生成和验证所需的两个关键输出：_AIR (算术中间表示) 私有输入_ (witness) 和 _AIR 公共输入_：

- AIR 私有输入包括 _执行跟踪_（或简称“跟踪”）和 _内存_。
- AIR 公共输入包括 _初始和最终状态_（跟踪的第一项和最后一项）、_公共内存_（内存的一个子集）和执行的配置数据（例如布局）。

证明者获取 AIR 的私有和公共输入以生成相应程序执行的证明。验证者随后可以根据证明和 AIR 公共输入异步验证证明的正确性。

不过，什么是 AIR？

## 算术中间表示 - AIR

AIR 代表 _算术中间表示 (Arithmetic Intermediate Representation)_，这是一种算术化技术。算术化是每个证明系统的基础：STARK 使用 AIR，而其他证明系统可能依赖不同的技术（例如 R1CS、PLONKish 算术化）。它允许将计算陈述转换为一组多项式方程。这些多项式方程代表系统的约束：如果在遵循证明系统协议的同时它们都成立，则证明有效；否则无效。

在其核心，Cairo 是一组 AIR，代表 Cairo ISA 的图灵完备机器：_Cairo 机器_。这使得通过 Cairo 机器证明任何陈述（即任意代码）成为可能。

Cairo 机器抽象了为你想要证明的程序编写 AIR 的需要，并且 Cairo 作为一种语言，提供了使用 Cairo 机器的人类可读界面。

Cairo 机器的每个组件都有其对应的 AIR：CPU、内存、内置函数 (Builtins)...

好的 AIR 对证明生成和验证的性能至关重要。虽然有很多方法可以将计算陈述表达为多项式，但并非所有方法都同样有效。编写最佳 AIR 是性能的一个重要因素。

我们不会在这里进一步讨论 AIR，但很高兴知道 CairoVM 的目的是向 Cairo 证明者提供所需的输入，以便为给定的 Cairo 程序生成证明。简而言之，Cairo 证明者和验证者的工作是验证 Cairo AIR 定义的约束对于 CairoVM 输出是否成立。

## Cairo 机器

Cairo 机器是定义冯·诺依曼架构以证明任意计算的理论模型。

机器由两个核心模型定义：

- CPU，或执行模型 - 指令集架构 (ISA)
- 内存模型 - 非确定性只读内存

执行模型通过三个关键组件指定 ISA：

- 指令集
- 寄存器 (`pc`, `ap`, `fp`)
- 状态转换算法

与 RISC-V 等通用 ISA 不同，Cairo 实现了其自己的专门针对证明生成和验证进行优化的 ISA——自定义零知识 ISA (ZK-ISA)。内存模型定义了 CPU 如何与内存交互。遵循冯·诺依曼架构原则，单个内存存储程序和指令数据。

Cairo 机器有两个版本：

1. _确定性机器_（由证明者使用）
2. _非确定性机器_（由验证者使用）

为什么有两个版本的 Cairo 机器，一个用于证明者，一个用于验证者？

### 确定性和非确定性 Cairo 机器

确定性机器获取跟踪（状态序列）和整个内存（内存函数），并验证两个连续状态之间的转换是否有效。如果所有状态转换都有效，则返回 `accept`，否则返回 `reject`。这台机器不执行任何计算，它只断言跟踪及其内存的有效性。

非确定性机器依赖于确定性机器：它只获取初始状态、最终状态和部分内存函数（即公共内存），如果存在具有相同初始状态和最终状态的状态序列（跟踪）以及扩展部分内存（包括公共内存的整个内存）的内存函数被确定性机器接受，则返回 `accept`。

确定性机器允许证明者生成证明，而非确定性机器允许验证者以零知识的方式简洁地验证证明（某些数据可以对验证者保密）。

CairoVM 是该理论机器的实现，包括一些从其设计中受益的功能（_内置函数_ 和 _提示_）。在 CairoVM 的各种实现中，我们称为 _Cairo Runner_ 的是运行 Cairo 程序并生成证明所需的 AIR 输入的入口点。

当 Cairo 程序由 CairoVM 执行时，我们可以将内存模型视为一次写入 (Write-Once) 模型。

#### 回顾 - 两个 Cairo 机器之间的区别

我们可以在表格中回顾确定性 Cairo 机器和非确定性 Cairo 机器之间的主要区别。

|        | 确定性 Cairo 机器 | 非确定性 Cairo 机器 |
| ------ | ----------------- | ------------------- |
| 用途   | 证明者            | 验证者              |
| 提示   | 执行              | 不知道它们          |
| 内存   | 完整内存          | 仅公共内存          |
| 跟踪   | 完整执行跟踪      | 仅初始和最终状态    |

## Cairo 虚拟机架构图

下图表示 CairoVM 的架构，用于为证明系统生成 AIR 输入。

<div align="center">
  <img src="cairo-vm-architecture.png" alt="CairoVM architecture" width="800px"/>
</div>
